
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Practical patterns and drills for high-quality Python development with geospatial data">
      
      
      
      
        <link rel="prev" href="../day02_oop/">
      
      
        <link rel="next" href="../day04_testing/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Overview - Python Geospatial Engineering Practices</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#day-03-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Geospatial Engineering Practices" class="md-header__button md-logo" aria-label="Python Geospatial Engineering Practices" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Geospatial Engineering Practices
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Overview
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="red"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="red"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../study_plan/" class="md-tabs__link">
          
  
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../day01_concurrency/" class="md-tabs__link">
          
  
  
  Training Modules

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Geospatial Engineering Practices" class="md-nav__button md-logo" aria-label="Python Geospatial Engineering Practices" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Python Geospatial Engineering Practices
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../study_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Study Plan
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Training Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Training Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 01 - Concurrency
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Day 01 - Concurrency
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day01_concurrency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 02 - Oop
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Day 02 - Oop
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day02_oop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 03 - Api
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Day 03 - Api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#graduate-level-learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Graduate-Level Learning Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#theoretical-foundation" class="md-nav__link">
    <span class="md-ellipsis">
      Theoretical Foundation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Theoretical Foundation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geospatial-api-architecture-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Geospatial API Architecture Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-api-design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Production API Design Principles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-fastapi-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. FastAPI Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      2. Pydantic Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-streaming-responses" class="md-nav__link">
    <span class="md-ellipsis">
      3. Streaming Responses
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-walkthrough-this-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Code Walkthrough (this repo)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Walkthrough (this repo)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-fastapi-app-structure" class="md-nav__link">
    <span class="md-ellipsis">
      1. Basic FastAPI App Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tile-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2. Tile Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-bounding-box-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      3. Bounding Box Endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    <span class="md-ellipsis">
      Run
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-setup" class="md-nav__link">
    <span class="md-ellipsis">
      1. Basic Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access" class="md-nav__link">
    <span class="md-ellipsis">
      Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smoke-it-with-curl" class="md-nav__link">
    <span class="md-ellipsis">
      Smoke it with curl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-implement-file-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      1) Implement File Streaming
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-add-pydantic-request-models" class="md-nav__link">
    <span class="md-ellipsis">
      2) Add Pydantic Request Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-implement-real-feature-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      3) Implement Real Feature Streaming
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-response-models" class="md-nav__link">
    <span class="md-ellipsis">
      1) Response Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-custom-response-classes" class="md-nav__link">
    <span class="md-ellipsis">
      2) Custom Response Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-middleware-and-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      3) Middleware and Dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      1. Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-input-validation" class="md-nav__link">
    <span class="md-ellipsis">
      2. Input Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      3. Performance Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-forgetting-to-await" class="md-nav__link">
    <span class="md-ellipsis">
      1. Forgetting to Await
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-blocking-operations" class="md-nav__link">
    <span class="md-ellipsis">
      2. Blocking Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-memory-issues-with-large-data" class="md-nav__link">
    <span class="md-ellipsis">
      3. Memory Issues with Large Data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enterprise-production-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Enterprise Production Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enterprise Production Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservices-architecture-for-geospatial-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Microservices Architecture for Geospatial Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-error-handling-and-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Error Handling and Resilience
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-streaming-and-real-time-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Streaming and Real-Time Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-and-authentication-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security and Authentication Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization-and-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization and Caching
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observability-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Observability and Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-integration-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Integration Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-World Integration Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integration-with-postgis" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with PostGIS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-storage-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Storage Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#industry-standards-and-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      Industry Standards and Compliance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Industry Standards and Compliance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ogc-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      OGC Compliance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#professional-development-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Professional Development Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Professional Development Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-build-a-multi-tenant-geospatial-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Build a Multi-Tenant Geospatial API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-real-time-location-tracking-service" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: Real-Time Location Tracking Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-distributed-tile-caching-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: Distributed Tile Caching System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-geospatial-data-pipeline-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Geospatial Data Pipeline API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#technical-standards" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Standards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-and-python" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI and Python
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geospatial-technologies" class="md-nav__link">
    <span class="md-ellipsis">
      Geospatial Technologies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Operations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 04 - Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Day 04 - Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day04_testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 05 - Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Day 05 - Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day05_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 06 - Perf
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Day 06 - Perf
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day06_perf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Day 07 - Mock
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Day 07 - Mock
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../day07_mock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#graduate-level-learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Graduate-Level Learning Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#theoretical-foundation" class="md-nav__link">
    <span class="md-ellipsis">
      Theoretical Foundation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Theoretical Foundation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#geospatial-api-architecture-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Geospatial API Architecture Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-api-design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Production API Design Principles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-fastapi-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. FastAPI Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      2. Pydantic Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-streaming-responses" class="md-nav__link">
    <span class="md-ellipsis">
      3. Streaming Responses
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-walkthrough-this-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Code Walkthrough (this repo)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Code Walkthrough (this repo)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-fastapi-app-structure" class="md-nav__link">
    <span class="md-ellipsis">
      1. Basic FastAPI App Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tile-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2. Tile Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-bounding-box-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      3. Bounding Box Endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    <span class="md-ellipsis">
      Run
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-basic-setup" class="md-nav__link">
    <span class="md-ellipsis">
      1. Basic Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access" class="md-nav__link">
    <span class="md-ellipsis">
      Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smoke-it-with-curl" class="md-nav__link">
    <span class="md-ellipsis">
      Smoke it with curl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-implement-file-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      1) Implement File Streaming
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-add-pydantic-request-models" class="md-nav__link">
    <span class="md-ellipsis">
      2) Add Pydantic Request Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-implement-real-feature-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      3) Implement Real Feature Streaming
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-response-models" class="md-nav__link">
    <span class="md-ellipsis">
      1) Response Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-custom-response-classes" class="md-nav__link">
    <span class="md-ellipsis">
      2) Custom Response Classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-middleware-and-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      3) Middleware and Dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      1. Error Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-input-validation" class="md-nav__link">
    <span class="md-ellipsis">
      2. Input Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      3. Performance Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-forgetting-to-await" class="md-nav__link">
    <span class="md-ellipsis">
      1. Forgetting to Await
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-blocking-operations" class="md-nav__link">
    <span class="md-ellipsis">
      2. Blocking Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-memory-issues-with-large-data" class="md-nav__link">
    <span class="md-ellipsis">
      3. Memory Issues with Large Data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next Steps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enterprise-production-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Enterprise Production Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enterprise Production Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#microservices-architecture-for-geospatial-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Microservices Architecture for Geospatial Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-error-handling-and-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Error Handling and Resilience
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-streaming-and-real-time-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Streaming and Real-Time Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-and-authentication-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security and Authentication Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization-and-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization and Caching
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observability-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Observability and Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-integration-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Integration Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-World Integration Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integration-with-postgis" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with PostGIS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-storage-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Storage Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#industry-standards-and-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      Industry Standards and Compliance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Industry Standards and Compliance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ogc-compliance" class="md-nav__link">
    <span class="md-ellipsis">
      OGC Compliance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#professional-development-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Professional Development Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Professional Development Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-build-a-multi-tenant-geospatial-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Build a Multi-Tenant Geospatial API
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-real-time-location-tracking-service" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: Real-Time Location Tracking Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-distributed-tile-caching-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: Distributed Tile Caching System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-geospatial-data-pipeline-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Geospatial Data Pipeline API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#technical-standards" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Standards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-and-python" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI and Python
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geospatial-technologies" class="md-nav__link">
    <span class="md-ellipsis">
      Geospatial Technologies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Operations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="day-03-api">Day 03 - Api</h1>
<h2 id="graduate-level-learning-objectives">Graduate-Level Learning Objectives</h2>
<p>This module covers enterprise-grade API design and implementation for geospatial services, focusing on scalability, reliability, and maintainability patterns used in production mapping and location-based systems. By the end of this module, you will understand:</p>
<ul>
<li><strong>RESTful API design principles</strong> for geospatial resource modeling and hypermedia controls</li>
<li><strong>OpenAPI specification mastery</strong> including advanced schema composition and documentation generation</li>
<li><strong>Streaming architecture patterns</strong> for real-time geospatial data delivery and backpressure handling</li>
<li><strong>Production observability</strong> with structured logging, metrics collection, and distributed tracing</li>
<li><strong>Geospatial-specific API patterns</strong> including tiling protocols, spatial query optimization, and CRS handling</li>
<li><strong>Service mesh integration</strong> for microservices communication and traffic management</li>
<li><strong>API versioning strategies</strong> for evolving geospatial schemas and backward compatibility</li>
</ul>
<h2 id="theoretical-foundation">Theoretical Foundation</h2>
<h3 id="geospatial-api-architecture-patterns">Geospatial API Architecture Patterns</h3>
<p><strong>Resource-Oriented Design:</strong>
Geospatial APIs model spatial entities as first-class resources with clear hierarchies and relationships:</p>
<div class="highlight"><pre><span></span><code>/datasets/{dataset_id}                    # Spatial dataset resource
├── /features                            # Feature collection
│   ├── /{feature_id}                   # Individual feature
│   └── /bbox/{bbox}                    # Spatial query
├── /tiles/{z}/{x}/{y}                  # Tile hierarchy
└── /metadata                           # Dataset metadata
</code></pre></div>
<p><strong>Streaming-First Architecture:</strong>
Large geospatial datasets require streaming patterns to prevent memory exhaustion and improve time-to-first-byte:
- <strong>NDJSON streams</strong> for feature collections
- <strong>Chunked tile responses</strong> for large raster data
- <strong>Server-sent events</strong> for real-time location updates
- <strong>WebSocket protocols</strong> for bidirectional spatial data exchange</p>
<p><strong>Spatial Query Optimization:</strong>
- <strong>Bounding box queries</strong> with spatial indexing
- <strong>Multi-resolution tiling</strong> for efficient data serving
- <strong>Coordinate reference system (CRS) transformations</strong> at API boundaries
- <strong>Geometry simplification</strong> based on zoom levels and client capabilities</p>
<h3 id="production-api-design-principles">Production API Design Principles</h3>
<p><strong>Idempotency and Consistency:</strong>
Geospatial updates must maintain spatial integrity and referential consistency across distributed systems.</p>
<p><strong>Eventual Consistency Models:</strong>
Location-based services often require eventual consistency for performance, using patterns like:
- <strong>CQRS (Command Query Responsibility Segregation)</strong> for read/write optimization
- <strong>Event sourcing</strong> for audit trails and temporal queries
- <strong>Conflict-free replicated data types (CRDTs)</strong> for distributed spatial editing</p>
<p><strong>Rate Limiting and Fair Usage:</strong>
Tile servers and geocoding APIs implement sophisticated rate limiting:
- <strong>Token bucket algorithms</strong> for burst handling
- <strong>Geographic rate limiting</strong> based on request density
- <strong>Adaptive throttling</strong> based on downstream service health</p>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="1-fastapi-overview">1. FastAPI Overview</h3>
<p>FastAPI uses type hints to validate inputs and auto-generate OpenAPI docs. It’s async-first and great for streaming responses.</p>
<h3 id="2-pydantic-models">2. Pydantic Models</h3>
<p>Pydantic provides data validation using Python type annotations. It's the foundation for FastAPI's request/response validation.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TilePath</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Zoom level (0-22)&quot;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tile X coordinate&quot;</span><span class="p">)</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tile Y coordinate&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Validation Features:</strong>
- Type checking and conversion
- Constraint validation (min/max values, regex patterns)
- Custom validators
- Automatic serialization/deserialization</p>
<h3 id="3-streaming-responses">3. Streaming Responses</h3>
<p>For large datasets, streaming responses prevent memory issues and improve user experience:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamingResponse</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_large_dataset</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">large_dataset</span><span class="p">:</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">generate</span><span class="p">(),</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="code-walkthrough-this-repo">Code Walkthrough (this repo)</h2>
<h3 id="1-basic-fastapi-app-structure">1. Basic FastAPI App Structure</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamingResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spatial API Drills&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Key Components:</strong>
- <code>FastAPI()</code>: Main application instance
- <code>title</code>: Sets the API title in OpenAPI docs
- Additional metadata can be added for better documentation</p>
<h3 id="2-tile-endpoint">2. Tile Endpoint</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tiles/</span><span class="si">{z}</span><span class="s2">/</span><span class="si">{x}</span><span class="s2">/</span><span class="si">{y}</span><span class="s2">.mvt&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_tile</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid zoom&quot;</span><span class="p">)</span>

    <span class="c1"># Demo stream of empty tile</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streamer</span><span class="p">():</span>
        <span class="k">yield</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>  <span class="c1"># replace with file streaming in drill</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">streamer</span><span class="p">(),</span> 
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.mapbox-vector-tile&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<p><strong>Features:</strong>
- <strong>Path Parameters</strong>: <code>{z}</code>, <code>{x}</code>, <code>{y}</code> are automatically parsed and validated
- <strong>Validation</strong>: Zoom level is checked (0-22 range)
- <strong>Error Handling</strong>: <code>HTTPException</code> returns proper HTTP status codes
- <strong>Streaming</strong>: Uses <code>StreamingResponse</code> for efficient data delivery</p>
<h3 id="3-bounding-box-endpoint">3. Bounding Box Endpoint</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/stream-features&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_features</span><span class="p">(</span>
    <span class="n">min_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="n">min_lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="n">max_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
    <span class="n">max_lon</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">min_lat</span> <span class="o">&gt;</span> <span class="n">max_lat</span> <span class="ow">or</span> <span class="n">min_lon</span> <span class="o">&gt;</span> <span class="n">max_lon</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid bbox&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streamer</span><span class="p">():</span>
        <span class="c1"># demo NDJSON</span>
        <span class="k">yield</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">streamer</span><span class="p">(),</span> 
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/x-ndjson&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<p><strong>Features:</strong>
- <strong>Query Parameters</strong>: Automatically parsed from URL query string
- <strong>Validation</strong>: Checks that bounding box coordinates are valid
- <strong>NDJSON Format</strong>: Newline-delimited JSON for streaming</p>
<h2 id="run">Run</h2>
<h3 id="1-basic-setup">1. Basic Setup</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Activate virtual environment</span>
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate

<span class="c1"># Install dependencies</span>
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c1"># Run the API (dev)</span>
uvicorn<span class="w"> </span>src.day03_api.app:app<span class="w"> </span>--reload
</code></pre></div>
<h3 id="access">Access</h3>
<ul>
<li>API: <a href="http://localhost:8000">http://localhost:8000</a></li>
<li>Interactive Docs: <a href="http://localhost:8000/docs">http://localhost:8000/docs</a></li>
<li>OpenAPI Schema: <a href="http://localhost:8000/openapi.json">http://localhost:8000/openapi.json</a></li>
<li>Prometheus Metrics: <a href="http://localhost:8000/metrics">http://localhost:8000/metrics</a></li>
</ul>
<h3 id="smoke-it-with-curl">Smoke it with curl</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Test tile endpoint</span>
curl<span class="w"> </span><span class="s2">&quot;http://localhost:8000/tiles/5/10/12.mvt&quot;</span>

<span class="c1"># Test bbox endpoint</span>
curl<span class="w"> </span><span class="s2">&quot;http://localhost:8000/stream-features?min_lat=37.0&amp;min_lon=-122.0&amp;max_lat=38.0&amp;max_lon=-121.0&quot;</span>
</code></pre></div>
<h2 id="exercises">Exercises</h2>
<h3 id="1-implement-file-streaming">1) Implement File Streaming</h3>
<p>Replace the placeholder tile streaming with actual file reading:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tiles/</span><span class="si">{z}</span><span class="s2">/</span><span class="si">{x}</span><span class="s2">/</span><span class="si">{y}</span><span class="s2">.mvt&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_tile</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid zoom&quot;</span><span class="p">)</span>

    <span class="c1"># Construct file path</span>
    <span class="n">tile_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tiles/</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">.mvt&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tile_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Tile not found&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_tile</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tile_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">chunk</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">):</span>  <span class="c1"># 8KB chunks</span>
                <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">stream_tile</span><span class="p">(),</span>
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.mapbox-vector-tile&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">)}</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="2-add-pydantic-request-models">2) Add Pydantic Request Models</h3>
<p>Create proper request models for validation:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BoundingBox</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">min_lat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum latitude&quot;</span><span class="p">)</span>
    <span class="n">min_lon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=-</span><span class="mi">180</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum longitude&quot;</span><span class="p">)</span>
    <span class="n">max_lat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum latitude&quot;</span><span class="p">)</span>
    <span class="n">max_lon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=-</span><span class="mi">180</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum longitude&quot;</span><span class="p">)</span>
    <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum features to return&quot;</span><span class="p">)</span>
    <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of features to skip&quot;</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;max_lat&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_lat_must_be_greater</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;min_lat&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;min_lat&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_lat must be greater than min_lat&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;max_lon&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_lon_must_be_greater</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;min_lon&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;min_lon&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_lon must be greater than min_lon&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/stream-features&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_features_post</span><span class="p">(</span><span class="n">bbox</span><span class="p">:</span> <span class="n">BoundingBox</span><span class="p">):</span>
    <span class="c1"># Now we have validated bbox data</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streamer</span><span class="p">():</span>
        <span class="c1"># TODO: Implement actual feature streaming</span>
        <span class="k">yield</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;bbox&quot;: </span><span class="si">{</span><span class="n">bbox</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span><span class="si">}</span><span class="se">}}\n</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">streamer</span><span class="p">(),</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/x-ndjson&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="3-implement-real-feature-streaming">3) Implement Real Feature Streaming</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.wkt</span><span class="w"> </span><span class="kn">import</span> <span class="n">loads</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/stream-features&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_features</span><span class="p">(</span>
    <span class="n">min_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">min_lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">min_lat</span> <span class="o">&gt;</span> <span class="n">max_lat</span> <span class="ow">or</span> <span class="n">min_lon</span> <span class="o">&gt;</span> <span class="n">max_lon</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid bbox&quot;</span><span class="p">)</span>

    <span class="c1"># Load features (in practice, this would come from a database)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">load_features_from_source</span><span class="p">()</span>

    <span class="c1"># Filter by bounding box</span>
    <span class="n">query_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">)</span>
    <span class="n">filtered_features</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span> 
        <span class="k">if</span> <span class="n">query_bbox</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]))</span>
    <span class="p">]</span>

    <span class="c1"># Apply pagination</span>
    <span class="n">paginated_features</span> <span class="o">=</span> <span class="n">filtered_features</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">limit</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">streamer</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">paginated_features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">streamer</span><span class="p">(),</span>
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/x-ndjson&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;X-Total-Count&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_features</span><span class="p">)),</span>
            <span class="s2">&quot;X-Page-Size&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paginated_features</span><span class="p">)),</span>
            <span class="s2">&quot;X-Page-Offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>
<h2 id="advanced">Advanced</h2>
<h3 id="1-response-models">1) Response Models</h3>
<p>Define explicit response models for better documentation:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Feature</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Feature&quot;</span>
    <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">geometry</span><span class="p">:</span> <span class="nb">dict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FeatureCollection</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FeatureCollection&quot;</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">]</span>
    <span class="n">total_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">page_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">page_offset</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/features&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">FeatureCollection</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_features</span><span class="p">(</span>
    <span class="n">min_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">min_lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">):</span>
    <span class="c1"># Implementation here</span>
    <span class="k">pass</span>
</code></pre></div>
<h3 id="2-custom-response-classes">2) Custom Response Classes</h3>
<p>Create custom response types for specific use cases:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GeoJSONResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
            <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/geo+json&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/features/geojson&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_features_geojson</span><span class="p">():</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">return</span> <span class="n">GeoJSONResponse</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</code></pre></div>
<h3 id="3-middleware-and-dependencies">3) Middleware and Dependencies</h3>
<p>Add cross-cutting concerns:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> took </span><span class="si">{</span><span class="n">process_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tiles/</span><span class="si">{z}</span><span class="s2">/</span><span class="si">{x}</span><span class="s2">/</span><span class="si">{y}</span><span class="s2">.mvt&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">log_request</span><span class="p">)])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_tile</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Implementation here</span>
    <span class="k">pass</span>
</code></pre></div>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-error-handling">1. Error Handling</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/tiles/</span><span class="si">{z}</span><span class="s2">/</span><span class="si">{x}</span><span class="s2">/</span><span class="si">{y}</span><span class="s2">.mvt&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_tile</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Implementation</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tile </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> not found&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error&quot;</span>
        <span class="p">)</span>
</code></pre></div>
<h3 id="2-input-validation">2. Input Validation</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">validator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TileRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_coordinates</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">max_coord</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">max_coord</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Coordinate </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> exceeds maximum for zoom </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>
<h3 id="3-performance-considerations">3. Performance Considerations</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Use async for I/O operations</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_tile_data</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Async file reading or database query</span>
    <span class="k">pass</span>

<span class="c1"># Use streaming for large responses</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_large_dataset</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generator</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">async_data_source</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">generator</span><span class="p">())</span>
</code></pre></div>
<h2 id="common-pitfalls">Common Pitfalls</h2>
<h3 id="1-forgetting-to-await">1. Forgetting to Await</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ This won&#39;t work</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fetch_from_database</span><span class="p">()</span>  <span class="c1"># Missing await</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ✅ Correct async usage</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_from_database</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="2-blocking-operations">2. Blocking Operations</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ This blocks the event loop</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/slow&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">slow_endpoint</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Blocks everything</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;done&quot;</span><span class="p">}</span>

<span class="c1"># ✅ Use asyncio.sleep or run in thread</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/slow&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">slow_endpoint</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Non-blocking</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;done&quot;</span><span class="p">}</span>
</code></pre></div>
<h3 id="3-memory-issues-with-large-data">3. Memory Issues with Large Data</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ Loads everything into memory</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/large-dataset&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_large_dataset</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_all_data</span><span class="p">()</span>  <span class="c1"># Could be GB of data</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># ✅ Stream the data</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/large-dataset&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_large_dataset</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">load_data_stream</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">stream</span><span class="p">())</span>
</code></pre></div>
<h2 id="next-steps">Next Steps</h2>
<p>After completing this day:
1. Implement actual file streaming for tiles
2. Add database integration for features
3. Implement proper error handling and logging
4. Add authentication and rate limiting
5. Consider adding caching (Redis, etc.)</p>
<h2 id="enterprise-production-patterns">Enterprise Production Patterns</h2>
<h3 id="microservices-architecture-for-geospatial-systems">Microservices Architecture for Geospatial Systems</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Service discovery and configuration</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ServiceRegistry</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_checks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">health_check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">health_check</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">discover_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">:</span>
            <span class="c1"># Check health before returning</span>
            <span class="n">is_healthy</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_health_checks</span><span class="p">[</span><span class="n">name</span><span class="p">]()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Circuit breaker for downstream services</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreaker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
                 <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span> <span class="o">=</span> <span class="n">failure_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">timeout_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;CLOSED&quot;</span>  <span class="c1"># CLOSED, OPEN, HALF_OPEN</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_seconds</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;HALF_OPEN&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">503</span><span class="p">,</span> <span class="s2">&quot;Service temporarily unavailable&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;HALF_OPEN&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;CLOSED&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;OPEN&quot;</span>

            <span class="k">raise</span> <span class="n">e</span>

<span class="c1"># Geospatial-specific middleware</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">geospatial_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
    <span class="c1"># Add spatial context to request</span>
    <span class="k">if</span> <span class="s2">&quot;bbox&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">spatial_context</span> <span class="o">=</span> <span class="n">parse_bbox</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>

    <span class="c1"># Add coordinate system info</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Accept-CRS&quot;</span><span class="p">,</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">target_crs</span> <span class="o">=</span> <span class="n">crs</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># Add spatial headers to response</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;spatial_context&quot;</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-CRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_bbox</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">spatial_context</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h3 id="advanced-error-handling-and-resilience">Advanced Error Handling and Resilience</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeospatialError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for geospatial operations.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidGeometryError</span><span class="p">(</span><span class="n">GeospatialError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when geometry is invalid or malformed.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SpatialIndexError</span><span class="p">(</span><span class="n">GeospatialError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when spatial index operations fail.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">GeospatialError</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">geospatial_error_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">GeospatialError</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Retry decorator for external service calls</span>
<span class="k">def</span><span class="w"> </span><span class="nf">retry_with_backoff</span><span class="p">(</span><span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">RequestError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span>

                    <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>
<h3 id="advanced-streaming-and-real-time-patterns">Advanced Streaming and Real-Time Patterns</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatialEventStream</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time spatial event streaming.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Queue</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_index</span> <span class="o">=</span> <span class="n">rtree</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">Index</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">subscribe_to_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> 
                                  <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subscribe client to events in a spatial region.&quot;&quot;&quot;</span>
        <span class="n">region_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bbox_</span><span class="si">{</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">region_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client_queue</span><span class="p">)</span>

        <span class="c1"># Add region to spatial index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_index</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">client_queue</span><span class="p">),</span> <span class="n">bbox</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">publish_spatial_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Point</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish event to all subscribers in the area.&quot;&quot;&quot;</span>
        <span class="c1"># Find subscribers whose regions intersect with event location</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">intersecting_queues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bbox</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">queue_id</span> <span class="ow">in</span> <span class="n">intersecting_queues</span><span class="p">:</span>
            <span class="c1"># Find the actual queue object and send event</span>
            <span class="k">for</span> <span class="n">region_subscribers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">region_subscribers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="n">queue_id</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># Clean up disconnected clients</span>
                            <span class="n">region_subscribers</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s2">&quot;/ws/spatial-events&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">spatial_event_websocket</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="n">client_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get initial subscription parameters</span>
        <span class="n">bbox_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_json</span><span class="p">()</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bbox_data</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>

        <span class="c1"># Subscribe to spatial events</span>
        <span class="k">await</span> <span class="n">spatial_stream</span><span class="o">.</span><span class="n">subscribe_to_region</span><span class="p">(</span><span class="n">client_queue</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>

        <span class="c1"># Send events to client</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
        <span class="c1"># Clean up subscription</span>
        <span class="k">pass</span>
</code></pre></div>
<h3 id="security-and-authentication-patterns">Security and Authentication Patterns</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># JWT-based authentication with spatial scopes</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpatialJWTBearer</span><span class="p">(</span><span class="n">HTTPBearer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_authority</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_authority</span> <span class="o">=</span> <span class="n">spatial_authority</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>

        <span class="c1"># Decode and validate JWT</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SPATIAL_SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>

            <span class="c1"># Check spatial permissions</span>
            <span class="n">spatial_scopes</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spatial_scopes&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">required_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_spatial_scope</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">required_scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spatial_scopes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;Insufficient spatial permissions&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">payload</span>

        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">PyJWTError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;Invalid authentication token&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_spatial_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine required spatial scope based on request.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;bbox&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">parse_bbox</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sensitive_area</span><span class="p">(</span><span class="n">bbox</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;sensitive_area_access&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;general_spatial_access&quot;</span>

<span class="c1"># API key rate limiting with geographic awareness</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GeographicRateLimiter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Point</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check rate limits with geographic weighting.&quot;&quot;&quot;</span>
        <span class="n">base_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rate_limit:</span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Standard rate limiting</span>
        <span class="n">current_count</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_key</span><span class="si">}</span><span class="s2">:count&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_count</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># 1000 req/hour</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Geographic rate limiting for high-value areas</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_high_traffic_area</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
            <span class="n">geo_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_key</span><span class="si">}</span><span class="s2">:geo:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_cell</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">geo_count</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">geo_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geo_count</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">geo_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># 100 req/hour per grid cell</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<h3 id="performance-optimization-and-caching">Performance Optimization and Caching</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatialCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-level spatial caching system.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">,</span> <span class="n">memory_cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">memory_cache_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bloom_filter</span> <span class="o">=</span> <span class="n">BloomFilter</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">error_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_features_in_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                                   <span class="n">zoom_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cached features with spatial and zoom-level awareness.&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;features:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hash_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span><span class="si">}</span><span class="s2">:z</span><span class="si">{</span><span class="n">zoom_level</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check bloom filter first</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bloom_filter</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check memory cache</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="c1"># Check Redis cache</span>
        <span class="n">cached_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
            <span class="k">return</span> <span class="n">features</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cache_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                           <span class="n">zoom_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
                           <span class="n">ttl_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache features with appropriate TTL based on data volatility.&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;features:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hash_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span><span class="si">}</span><span class="s2">:z</span><span class="si">{</span><span class="n">zoom_level</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Add to bloom filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bloom_filter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

        <span class="c1"># Cache in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>

        <span class="c1"># Cache in Redis with TTL</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
            <span class="n">cache_key</span><span class="p">,</span> 
            <span class="n">ttl_seconds</span><span class="p">,</span> 
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">GeospatialJSONEncoder</span><span class="p">)</span>
        <span class="p">)</span>

<span class="c1"># Geometry simplification middleware</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">geometry_optimization_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># Simplify geometries based on zoom level and viewport</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/geo+json&quot;</span> <span class="ow">and</span>
        <span class="s2">&quot;zoom&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">):</span>

        <span class="n">zoom_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">])</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="n">calculate_simplification_tolerance</span><span class="p">(</span><span class="n">zoom_level</span><span class="p">)</span>

        <span class="c1"># Simplify response geometries</span>
        <span class="n">simplified_content</span> <span class="o">=</span> <span class="n">simplify_geojson_response</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">tolerance</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">simplified_content</span><span class="p">,</span>
            <span class="n">media_type</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h3 id="observability-and-monitoring">Observability and Monitoring</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Structured logging for geospatial operations</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpatialLogger</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_spatial_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                         <span class="n">feature_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">query_time_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;spatial_query_executed&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
            <span class="n">feature_count</span><span class="o">=</span><span class="n">feature_count</span><span class="p">,</span>
            <span class="n">query_time_ms</span><span class="o">=</span><span class="n">query_time_ms</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
            <span class="n">bbox_area</span><span class="o">=</span><span class="n">calculate_bbox_area</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="p">)</span>

<span class="c1"># Distributed tracing for spatial operations</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trace_spatial_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="c1"># Add spatial context to trace</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;spatial_context&quot;</span><span class="p">):</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">spatial_context</span>
            <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;spatial.bbox&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bbox</span><span class="p">))</span>
            <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;spatial.area&quot;</span><span class="p">,</span> <span class="n">calculate_bbox_area</span><span class="p">(</span><span class="n">bbox</span><span class="p">))</span>

        <span class="k">yield</span> <span class="n">span</span>

<span class="c1"># Custom metrics for geospatial APIs</span>
<span class="n">SPATIAL_QUERY_HISTOGRAM</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s2">&quot;spatial_query_duration_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Time spent executing spatial queries&quot;</span><span class="p">,</span>
    <span class="n">labelnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;query_type&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom_level&quot;</span><span class="p">,</span> <span class="s2">&quot;result_size_category&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">SPATIAL_CACHE_HIT_COUNTER</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s2">&quot;spatial_cache_hits_total&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Number of spatial cache hits&quot;</span><span class="p">,</span>
    <span class="n">labelnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cache_level&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom_level&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">spatial_metrics_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Record spatial query metrics</span>
    <span class="k">if</span> <span class="s2">&quot;/bbox&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">zoom_level</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zoom&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">result_count</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Feature-Count&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">result_category</span> <span class="o">=</span> <span class="n">categorize_result_size</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result_count</span><span class="p">))</span>

        <span class="n">SPATIAL_QUERY_HISTOGRAM</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">query_type</span><span class="o">=</span><span class="s2">&quot;bbox&quot;</span><span class="p">,</span>
            <span class="n">zoom_level</span><span class="o">=</span><span class="n">zoom_level</span><span class="p">,</span>
            <span class="n">result_size_category</span><span class="o">=</span><span class="n">result_category</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h2 id="real-world-integration-examples">Real-World Integration Examples</h2>
<h3 id="integration-with-postgis">Integration with PostGIS</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PostGISSpatialService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-ready PostGIS integration.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">:</span> <span class="n">asyncpg</span><span class="o">.</span><span class="n">Pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">connection_pool</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_features_in_bbox</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">geometry_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;geom&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Efficient spatial query with PostGIS.&quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT </span>
<span class="s2">            ST_AsGeoJSON(</span><span class="si">{</span><span class="n">geometry_column</span><span class="si">}</span><span class="s2">) as geometry,</span>
<span class="s2">            jsonb_build_object(</span>
<span class="s2">                &#39;id&#39;, id,</span>
<span class="s2">                &#39;properties&#39;, properties</span>
<span class="s2">            ) as feature</span>
<span class="s2">        FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">        WHERE ST_Intersects(</span>
<span class="s2">            </span><span class="si">{</span><span class="n">geometry_column</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">            ST_MakeEnvelope($1, $2, $3, $4, 4326)</span>
<span class="s2">        )</span>
<span class="s2">        ORDER BY ST_Area(</span><span class="si">{</span><span class="n">geometry_column</span><span class="si">}</span><span class="s2">) DESC</span>
<span class="s2">        LIMIT $5 OFFSET $6</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span>
            <span class="p">)</span>

            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">geometry</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="n">feature_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">])</span>

                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">feature_data</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">feature_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="p">})</span>

            <span class="k">return</span> <span class="n">features</span>
</code></pre></div>
<h3 id="cloud-storage-integration">Cloud Storage Integration</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CloudOptimizedGeoTIFFService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service for streaming Cloud Optimized GeoTIFF data.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">s3_client</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_cog_tile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bands</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamingResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stream tile from Cloud Optimized GeoTIFF.&quot;&quot;&quot;</span>

        <span class="c1"># Calculate byte range for tile</span>
        <span class="n">tile_bounds</span> <span class="o">=</span> <span class="n">calculate_tile_bounds</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">byte_range</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cog_byte_range</span><span class="p">(</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tile_bounds</span><span class="p">,</span> <span class="n">bands</span>
        <span class="p">)</span>

        <span class="c1"># Stream partial object from S3</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tile_generator</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
                <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                <span class="n">Range</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bytes=</span><span class="si">{</span><span class="n">byte_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">byte_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">chunk</span>

        <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
            <span class="n">tile_generator</span><span class="p">(),</span>
            <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;image/tiff&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Content-Length&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">byte_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">byte_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;Accept-Ranges&quot;</span><span class="p">:</span> <span class="s2">&quot;bytes&quot;</span>
            <span class="p">}</span>
        <span class="p">)</span>
</code></pre></div>
<h2 id="industry-standards-and-compliance">Industry Standards and Compliance</h2>
<h3 id="ogc-compliance">OGC Compliance</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OGCCompliantFeatureService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OGC Web Feature Service (WFS) compliant implementation.&quot;&quot;&quot;</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/wfs&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">XMLResponse</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_capabilities</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return WFS capabilities document.&quot;&quot;&quot;</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">generate_wfs_capabilities</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">XMLResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">capabilities</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/wfs/features&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">FeatureCollection</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_features</span><span class="p">(</span>
        <span class="n">service</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="s2">&quot;WFS&quot;</span><span class="p">),</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="s2">&quot;2.0.0&quot;</span><span class="p">),</span>
        <span class="n">request</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="s2">&quot;GetFeature&quot;</span><span class="p">),</span>
        <span class="n">typeName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">maxFeatures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
        <span class="n">outputFormat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="s2">&quot;application/geopackage+sqlite3&quot;</span><span class="p">)</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;OGC WFS GetFeature operation.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">service</span> <span class="o">!=</span> <span class="s2">&quot;WFS&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Invalid service parameter&quot;</span><span class="p">)</span>

        <span class="c1"># Validate and parse parameters according to OGC spec</span>
        <span class="n">parsed_bbox</span> <span class="o">=</span> <span class="n">parse_ogc_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span> <span class="k">if</span> <span class="n">bbox</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Execute spatial query</span>
        <span class="n">features</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spatial_service</span><span class="o">.</span><span class="n">query_features</span><span class="p">(</span>
            <span class="n">type_name</span><span class="o">=</span><span class="n">typeName</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">parsed_bbox</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">maxFeatures</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">FeatureCollection</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</code></pre></div>
<h2 id="professional-development-exercises">Professional Development Exercises</h2>
<h3 id="exercise-1-build-a-multi-tenant-geospatial-api">Exercise 1: Build a Multi-Tenant Geospatial API</h3>
<p>Design and implement a multi-tenant spatial data API:
- Implement tenant isolation at the database level
- Add role-based access control for spatial operations
- Create tenant-specific rate limiting
- Implement cross-tenant spatial analytics (where permitted)</p>
<h3 id="exercise-2-real-time-location-tracking-service">Exercise 2: Real-Time Location Tracking Service</h3>
<p>Create a real-time location tracking and geofencing service:
- WebSocket-based real-time location updates
- Spatial event triggers and notifications
- Historical trajectory storage and querying
- Privacy controls and data retention policies</p>
<h3 id="exercise-3-distributed-tile-caching-system">Exercise 3: Distributed Tile Caching System</h3>
<p>Build a distributed tile caching and generation system:
- Multi-level caching (CDN, Redis, local)
- On-demand tile generation with queuing
- Cache invalidation strategies
- Performance monitoring and auto-scaling</p>
<h3 id="exercise-4-geospatial-data-pipeline-api">Exercise 4: Geospatial Data Pipeline API</h3>
<p>Design an API for managing geospatial ETL pipelines:
- Job scheduling and dependency management
- Progress tracking and error handling
- Data quality validation and reporting
- Integration with external data sources</p>
<h2 id="resources">Resources</h2>
<h3 id="technical-standards">Technical Standards</h3>
<ul>
<li><a href="https://www.ogc.org/standards/wfs">OGC Web Feature Service (WFS) 2.0</a></li>
<li><a href="https://ogcapi.ogc.org/features/">OGC API - Features</a></li>
<li><a href="https://wiki.osgeo.org/wiki/Tile_Map_Service_Specification">Tile Map Service (TMS) Specification</a></li>
<li><a href="https://www.cogeo.org/">Cloud Optimized GeoTIFF</a></li>
</ul>
<h3 id="fastapi-and-python">FastAPI and Python</h3>
<ul>
<li><a href="https://fastapi.tiangolo.com/">FastAPI Documentation</a></li>
<li><a href="https://pydantic-docs.helpmanual.io/">Pydantic Documentation</a></li>
<li><a href="https://swagger.io/specification/">OpenAPI Specification</a></li>
<li><a href="https://fastapi.tiangolo.com/advanced/custom-response/">Streaming Responses in FastAPI</a></li>
</ul>
<h3 id="geospatial-technologies">Geospatial Technologies</h3>
<ul>
<li><a href="https://postgis.net/documentation/">PostGIS Documentation</a></li>
<li><a href="https://gdal.org/python/">GDAL/OGR Python Bindings</a></li>
<li><a href="https://shapely.readthedocs.io/">Shapely Documentation</a></li>
<li><a href="https://geojson.org/">GeoJSON Specification</a></li>
</ul>
<h3 id="production-operations">Production Operations</h3>
<ul>
<li><a href="https://sre.google/books/">Site Reliability Engineering</a></li>
<li><a href="https://microservices.io/">Microservices Patterns by Chris Richardson</a></li>
<li><a href="https://www.oreilly.com/library/view/building-event-driven-microservices/9781492057888/">Building Event-Driven Microservices</a></li>
</ul>
<p>This module provides the foundation for building production-grade geospatial APIs that can scale to serve millions of users while maintaining data integrity, performance, and reliability standards expected in enterprise environments.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.follow", "search.suggest", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../javascripts/config.js"></script>
      
    
  </body>
</html>